# 示例<a name="apig-zh-api-180713012"></a>

## 概述<a name="section142673304107"></a>

本文通过调用接口注册一个HTTP类型API，介绍使用APIG API的基本流程。

注册API的流程如下：

1.  调用[Token认证](Token认证.md)接口获取用户Token，因为在后续的请求中需要将Token放到请求消息头中作为认证。
2.  调用[查询分组列表](查询分组列表.md)接口，查询可注册API的API分组列表。
3.  调用[注册API](注册API.md)接口注册一个HTTP类型API。

    注册成功后，可登录到管理控制台查看已注册的API。


## 前提条件<a name="section91264715102"></a>

-   已获取IAM的Endpoint，具体请参见[地区和终端节点](http://developer.huaweicloud.com/endpoint.html)。
-   已获取APIG的Endpoint，具体请参见[地区和终端节点](http://developer.huaweicloud.com/endpoint.html)。
-   已获取项目ID，具体请参见[获取项目编号](获取项目编号.md)。

## 操作步骤<a name="section680742610404"></a>

>![](public_sys-resources/icon-note.gif) **说明：**   
>为了安全起见，在服务器上使用curl命令调用接口查询信息后，需要清理历史操作记录，包括但不限于“\~/.bash\_history”、“/var/log/messages”（如有）。  

1.  调用[Token认证](Token认证.md)接口获取用户Token，并设置成环境变量，Token用于后续调用其他接口鉴权。
    1.  执行以下命令，获取用户Token。

        ```
        curl -X POST https://{iam_endpoint}/v3/auth/tokens -H 'content-type: application/json' -d '{
        	"auth": {
        		"identity": {
        			"methods": [
        				"password"
        			],
        			"password": {
        				"user": {
        				"name": "{user_name}",
        					"domain": {
        						"name": "{user_name}"
        					},
        			"password": "{password}"
        				}
        			}
        		},
        		"scope": {
        			"project": {
        				"id": "{project_id}"
        			}
        		}
        	}
        }' -vk
        ```

        上述命令中，部分参数请参见以下说明进行修改（具体请参考_《统一身份认证服务API参考》_）：

        -   _**\{iam\_endpoint\}**_替换为前提条件中获取的IAM的Endpoint。
        -   _**\{project\_id\}**_替换为前提条件中获取的项目ID。
        -   \{**_user\_name\}_**__和\{_**password\}**_分别替换为连接IAM服务器的用户名和密码。

        响应Header中“X-Subject-Token“的值即为Token：

        ```
        X-Subject-Token:MIIDkgYJKoZIhvcNAQcCoIIDgzCCA38CAQExDTALBglghkgBZQMEAgEwgXXXXX...
        ```

    2.  使用如下命令将token设置为环境变量，方便后续事项。

        **export Token=_\{_**_**X-Subject-Token\}**_

        **X-Subject-Token**即为上一步骤获取到的token，命令示例如下。

        ```
        export Token=MIIDkgYJKoZIhvcNAQcCoIIDgzCCA38CAQExDTALBglghkgBZQMEAgEwgXXXXX...
        ```


2.  <a name="li068011251502"></a>调用[查询分组列表](查询分组列表.md)接口，查询可注册API的API分组列表。

    查询API分组列表的请求消息样例如下：

    ```
    curl -X GET https://{apig_endpoint}/v1.0/apigw/api-groups -H 'content-type: application/json' -H "x-auth-token: $Token" -vk
    ```

    上述命令中，**_\{apig\_endpoint\}_**替换为前提条件中获取的APIG的Endpoint。

3.  调用[注册API](注册API.md)接口注册一个HTTP类型API。

    注册API的请求消息样例如下：

    ```
    curl -X POST https://{apig_endpoint}/v1.0/apigw/apis -H 'content-type: application/json' -H "x-auth-token: $Token" -d '{
            "auth_type": "app",
    	"backend_api": {
    		"remark": "web后端API",
    		"req_method": "get",
    		"req_protocol": "https",
    		"req_uri": "/v1.0/apigw/apis",
    		"timeout": 10000,
    		"url_domain": "192.168.1.5",
    		"version": "0.0.1",
    		"vpc_status": 2
    	},
    	"backend_type": "http",
            "group_id": "{group_id}
    	"match_mode": "normal",
    	"name": "查询API列表",
    	"remark": "查询API列表",
    	"req_method": "get",
    	"req_protocol": "https",
    	"req_uri": "/apis",
    	"type": 1,
    	"version": "0.0.1"
    }' -vk
    ```

    上述命令中，部分参数请参见以下说明进行修改（其他参数为自定义参数，请根据[注册API](注册API.md)中的参数解释进行设置）：

    -   **_\{apig\_endpoint\}_**替换为前提条件中获取的APIG的Endpoint。
    -   **_\{**_group\_id_**\}_**替换为[2](#li068011251502)中查询到的API分组列表中的任一API分组id。

4.  API注册完后，您可以在APIG的管理控制台查看到该API。

    **图 1**  查看API<a name="fig775989175411"></a>  
    ![](figures/查看API.png "查看API")


